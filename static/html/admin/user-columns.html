{{template "admin/include/header" .}}

<script>
    document.title = "User table fields"
</script>

<h1>User fields</h1>

<button type="button" onclick="openAdd()">Add column</button>

<table id="column-list-container">
    <thead>
        <tr>
            <td><input type="checkbox" name="select-all" placeholder="Select all" /></td>
            <th>Display name</th>
            <th>Column code</th>
            <th>Column type</th>
            <th>Column name</th>
            <th>Sort Order</th>
            <th>Control</th>
        </tr>
    </thead>
    <tr id="add-column">
        <td>&nbsp;</td>
        <td><input type="text" name="display-name" value="" placeholder="Display name" /></td>
        <td><input type="text" name="column-code" value="" placeholder="Column code" /></td>
        <td><input type="text" name="column-type" value="" onchange="restrictDatalist(this)" list="column-types" placeholder="Column type" /></td>
        <td><input type="text" name="column-name" value="" placeholder="Column name" /></td>
        <td>&nbsp;</td>
        <td>
            <button type="button" onclick="closeAdd()">Cancel</button>
            <button type="button" onclick="addColumn()">Save</button>
        </td>
    </tr>
    <tbody id="column-list-body" lr-loop="columnList">
        <tr lr-if="columnEditIndex != $index">
            <td><input type="checkbox" name="select$index" placeholder="Select" /></td>
            <td>
                {{"{{displayName}}"}}
            </td>
            <td>{{"columnCode"}}</td>
            <td>{{"columnType"}}</td>
            <td>{{"columnName"}}</td>
            <td>{{"sortOrder"}}</td>
            <td lr-if="$index <= 6">&nbsp;</td>
            <td lr-if="$index > 6">
                <button type="button" lr-click="openEdit($index)">Edit</button>
                <button type="button" lr-click="deleteColumn($index)">Delete</button>
            </td>
        </tr>
        <tr lr-if="columnEditIndex == $index">
            <td>&nbsp;</td>
            <td><input type="text" name="display-name" value="{{`{{displayName}}`}}" placeholder="Display name" /></td>
            <td><input type="text" name="column-code" value="{{`{{columnCode}}`}}" placeholder="Column code" /></td>
            <td><input type="text" name="column-type" value="{{`{{columnType}}`}}" onchange="restrictDatalist(this)" list="column-types" placeholder="Column type" disabled /></td>
            <td><input type="text" name="column-name" value="{{`{{columnName}}`}}" placeholder="Column name" /></td>
            <td>
                <input type="hidden" name="sort-order" value="{{`{{sortOrder}}`}}" />
                <span>{{`{{sortOrder}}`}}</span>
            </td>
            <td>
                <button type="button" onclick="closeEdit()">Cancel</button>
                <button type="button" onclick="updateColumn()">Save</button>
            </td>
        </tr>
    </tbody>
</table>

<datalist id="column-types">
    <option value="text">Text</option>
    <option value="number-integer">Number Integer</option>
    <option value="number-real">Number Real</option>
</datalist>

<script>
    let columnEditIndex = -1

    function restrictDatalist(e) {
        for (let i = 0; i < e.list.options.length; i++) {
            if (e.list.options[i].value == e.value) { return false }
        }
        e.value = ""
    }

    async function fetchRestricted() {
        return false
        columnEditIndex = -1

        const uri = "/api/admin/user-columns"
        const r = await fetch(uri, {
            method: 'GET',
            headers: { "Content-Type": "application/json" }
        })

        if (r.ok) {
            const data = await r.json()

            columnList = data
            lrColumnList.reload()

            document.querySelector("#column-list-body").style.display = "table-row-group"

            return false
        }
    }

    function openAdd() { document.querySelector("#add-column").style.display = "table-row" }
    function closeAdd() { document.querySelector("#add-column").style.display = "none" }
    async function addColumn() {
        const displayName = document.querySelector("#add-column input[name='display-name']").value
        const columnCode = document.querySelector("#add-column input[name='column-code']").value
        const columnType = document.querySelector("#add-column input[name='column-type']").value
        const columnName = document.querySelector("#add-column input[name='column-name']").value

        const data = {
            "display-name": displayName,
            "column-code": columnCode,
            "column-type": columnType,
            "column-name": columnName,
        }

        const uri = "/api/admin/user-columns"
        const r = await fetch(uri, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })

        if (r.ok) { fetchRestricted() }
    }

    function openEdit(idx) {
        columnEditIndex = idx
        lrColumnList.reload()
    }

    function closeEdit(event) {
        columnEditIndex = -1
        lrColumnList.reload()
    }

    async function updateColumn() {
        const displayName = document.querySelector("#column-list-body input[name='display-name']").value
        const columnCode = document.querySelector("#column-list-body input[name='column-code']").value
        const columnType = document.querySelector("#column-list-body input[name='column-type']").value
        const columnName = document.querySelector("#column-list-body input[name='column-name']").value
        const sortOrder = document.querySelector("#column-list-body input[name='sort-order']").value

        const data = {
            "idx": columnList[columnEditIndex].idx,
            "display-name": displayName,
            "column-code": columnCode,
            "column-type": columnType,
            "column-name": columnName,
            "sort-order": sortOrder,
        }

        const uri = "/api/admin/user-columns/column"
        const r = await fetch(uri, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })

        if (r.ok) { fetchRestricted() }
    }

    async function deleteColumn(index) {
        const uri = "/api/admin/user-columns/column" + "/" + columnList[index].idx
        const r = await fetch(uri, { method: "DELETE" })

        if (r.ok) { fetchRestricted() }
    }

    let columnList = new Array()
    const lrColumnList = new ListRenderer(document.querySelector("#column-list-container"))
    lrColumnList.render()

    // document.addEventListener("DOMContentLoaded", () => { fetchRestricted() })
</script>

<style>
    table,
    th,
    td {
        border: 1px solid black;
    }

    #add-column {
        display: none;
    }

    #column-list {
        display: none;
    }

    tbody>tr:hover {
        background-color: #f5f5f5;
    }
</style>

{{template "admin/include/footer" .}}
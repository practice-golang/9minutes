{{template "layout_board_header" .}}

<link rel="stylesheet" href="/assets/css/myeditor.css" />
<script src="/assets/js/myeditor.js"></script>

<style>
    a:hover {
        cursor: pointer;
    }

    .page-jump {
        display: none;
    }

    comment-modifier {
        display: none;
    }

    .comment-editor {
        resize: vertical;
        overflow: hidden;
        height: 10em;
        border: 1px solid silver;
    }
</style>

<div>
    <div>
        <h3>{{.Posting.Title.String}}</h3>
    </div>

    <div>
        <span>{{.Posting.AuthorName.String}}</span> |
        <span>{{format_date .Posting.RegDate.String}}</span> |
        <span>{{.Posting.Views.Int64}}</span>
    </div>

    <hr />

    <div>
        {{unescape .Posting.Content.String}}
    </div>

    <div id="fileslist-container">
        <ul></ul>
    </div>
</div>

<div>
    <button type="button" onclick="backToList()">List</button>
    <button type="button" onclick="moveToEdit()">Edit</button>
    <button type="button" onclick="deletePosting()">Delete</button>
</div>

<hr />

<!-- Comment -->
<div>
    <div id="comments">
        {{range .Comments.CommentList}}
        <span>{{.AuthorName.String}}</span>|
        <span>{{format_date .RegDate.String}}</span>|
        <button type="button" onclick="openEditComment('{{.Idx.Int64}}')">edit</button>
        <button type="button" onclick="deleteComment('{{.Idx.Int64}}')">delete</button>
        <span id="comment-{{.Idx.Int64}}">{{unescape .Content.String}}</span>
        <comment-modifier id="modifier-{{.Idx.Int64}}" data-idx="{{.Idx.Int64}}"></comment-modifier>
        {{end}}
    </div>
</div>

<div>
    <span class="page-jump">
        <a onclick="getComments(parseInt('1'))">&laquo;</a>
        <a onclick="getComments(parseInt('{{.Comments.CurrentPage}}')-5)">&lt;</a>
    </span>

    <span id="comment-pages">
        {{range .Comments.PageList}}
        {{if eq . $.Comments.CurrentPage}}
        <b>{{.}}</b>
        {{else}}
        <a onclick="getComments('{{.}}')">{{.}}</a>
        {{end}}
        {{end}}
    </span>

    <span class="page-jump">
        <a onclick="getComments(parseInt('{{.Comments.CurrentPage}}')+5)">&gt;</a>
        <a onclick="getComments('{{.Comments.TotalPage}}')">&raquo;</a>
    </span>

</div>

<div>
    <button type="button" onclick="backToList()">List</button>
    <button type="button" onclick="moveToEdit()">Edit</button>
    <button type="button" onclick="deletePosting()">Delete</button>
</div>

<hr />

<div id="editor" class="comment-editor"></div>
<div>
    <button type="button" onclick="writeComment()">Write comment</button>
</div>

<!-- Comment modification editor -->
<template id="modifier-template">
    <link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/myeditor.css" />

    <style>
        .comment-modifier {
            resize: vertical;
            overflow: hidden;
            height: 12em;
            border: 1px solid silver;
        }
    </style>

    <div class="comment-modifier-container">
        <div id="modifier" class="comment-modifier"></div>

        <div class="comment-fileslist-container">
            <ul></ul>
        </div>

        <div>
            <button type="button" onclick="cancelEditComment(this)">Cancel</button>
            <button type="button" onclick="updateComment(this)">Update</button>
        </div>
    </div>
</template>
<!-- Comment modification editor -->

<script>
    const imageUploadCallback = function (response) {
        console.log(response)
    }

    function decodeString(s) {
        const textArea = document.createElement("textarea")
        textArea.innerHTML = s

        const result = textArea.value
        textArea.remove()

        return result
    }
</script>

<script>
    const queries = new URLSearchParams(window.location.search)
    const boardCode = queries.get("board_code")
    const postingIdx = queries.get("idx")
    const fileIndices = "{{.Posting.Files.String}}"

    function backToList() { location.href = `/board/list?board_code=${boardCode}` }
    function moveToEdit() { location.href = `/board/edit?board_code=${boardCode}&idx=${postingIdx}` }
    async function deletePosting() {
        const uri = `/api/board/${boardCode}/posting/${postingIdx}`
        const r = await fetch(uri, { method: "DELETE" })

        if (r.ok) {
            alert("Deleted")
            backToList()
        }

        return false
    }

    const initialContent = ""
    const filesList = []

    const editorEL = document.querySelector("#editor")
    const options = {
        uploadActionURI: "/api/uploader",
        uploadAccessURI: "/upload",
        uploadCallback: imageUploadCallback,
    }
    const editor = new MyEditor(initialContent, editorEL, options)

    class modifierElement extends HTMLElement {
        constructor() {
            super()
            const templateContent = document.querySelector("#modifier-template").content
            const shadowRoot = this.attachShadow({ mode: "open" })
            shadowRoot.appendChild(templateContent.cloneNode(true))
        }
    }
    customElements.define("comment-modifier", modifierElement)

    const commentModifiers = {}
    let currentCommentPage = parseInt("{{.Comments.CurrentPage}}")
    let totalCommentPage = parseInt("{{.Comments.TotalPage}}")

    function showCommentPageJumper() {
        const commentPages = document.querySelector("#comment-pages")
        const pageJumper = document.querySelectorAll(".page-jump")

        let displayMode = "initial"
        if (commentPages.innerHTML.trim() == "") { displayMode = "none" }

        pageJumper.forEach((jumper) => { jumper.style.display = displayMode })
    }

    /*
    getComments(page)
    page: number - If page is 1, last comment page
     */
    async function getComments(page = 1) {
        page = parseInt(page)
        if (page < 0) { page = 1 } // last page
        if (page > totalCommentPage) { page = totalCommentPage }

        const commentsContainer = document.querySelector("#comments")
        const pageContainer = document.querySelector("#comment-pages")
        const uri = `/api/board/${boardCode}/${postingIdx}/comment?page=${page}`

        const r = await fetch(uri)

        let commentsHTML = ""
        if (r.ok) {
            const data = await r.json()
            totalCommentPage = data["total-page"]

            data["comment-list"] && data["comment-list"].forEach((comment) => {
                const regdate = dayjs(comment["regdate"]).format("YYYY-MM-DD HH:mm:ss")
                commentsHTML += `
                <span>${comment["author-name"]}</span>|
                <span>${regdate}</span>|
                <button type="button" onclick="openEditComment('${comment["idx"]}')">edit</button>
                <button type="button" onclick="deleteComment('${comment["idx"]}')">delete</button>
                <span id="comment-${comment['idx']}">${decodeString(comment["content"])}</span>
                <comment-modifier id="modifier-${comment["idx"]}" data-idx="${comment["idx"]}"></comment-modifier>
                `
            })
            commentsContainer.innerHTML = commentsHTML

            // paging
            const begin = data["current-page"] - 5 > 0 ? data["current-page"] - 5 : 1
            const fin = data["current-page"] + 5 <= data["total-page"] ? data["current-page"] + 5 : data["total-page"]

            if (page == 0) { page = totalCommentPage }

            let pages = ""
            data["page-list"].forEach((p) => {
                if (p == page) {
                    pages += `<b>${p}</b>`
                } else {
                    pages += `<a onclick="getComments('${p}')">${p}</a>`
                }
                pages += "\n"
            })
            pageContainer.innerHTML = pages

            currentCommentPage = data["current-page"]
            totalCommentPage = data["total-page"]

            showCommentPageJumper()
        }
    }

    async function writeComment() {
        const uri = `/api/board/${boardCode}/${postingIdx}/comment`
        const content = editor.getHTML()

        // const emptyContent = "<p><br></p>"
        const emptyContent = "<p></p>"
        if (content.trim() == emptyContent) {
            alert("Text is empty")
            return false
        }

        let fileIndices = ""
        for (const f of filesList) { fileIndices += `${f.idx}|` }
        if (fileIndices.length > 0) { fileIndices = fileIndices.slice(0, -1) }

        const data = {
            "author-idx": 1,
            "author-name": "admin",
            "content": content,
            "files": fileIndices
        }

        const r = await fetch(uri, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })

        if (r.ok) {
            getComments(0)
            editor.setHTML("")
            return false
        }

        alert("Write failed")
        return false
    }

    async function getFilesInfo() {
        const indexList = []
        for (const fidx of fileIndices.split("|")) {
            indexList.push({ idx: parseInt(fidx) })
        }

        const uri = "/api/uploader/files-info"

        const r = await fetch(uri, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(indexList)
        })

        if (r.ok) {
            const commentData = await r.json()

            const fcontainer = document.querySelector("#fileslist-container > ul")
            commentData.forEach((f) => {
                const a = document.createElement("a")
                a.setAttribute("href", `/upload/${f.storagename}`)
                a.setAttribute("target", "_blank")
                a.appendChild(document.createTextNode(`${f.filename}`))

                const li = document.createElement("li")
                li.setAttribute("id", `file-${f.idx}`)
                // li.appendChild(document.createTextNode(`${f.filename}`))
                li.appendChild(a)

                fcontainer.appendChild(li)
                filesList.push(f)
            })
        }
    }

    function openEditComment(idx) {
        const modifierEL = document.querySelector(`comment-modifier#modifier-${idx}`)
        const modifierROOT = modifierEL.shadowRoot
        const modContent = document.querySelector(`#comment-${idx}`).innerHTML

        const editorEL = modifierROOT.querySelector("#modifier")
        const options = {
            uploadActionURI: "/api/uploader",
            uploadAccessURI: "/upload",
            uploadCallback: imageUploadCallback,
        }

        if (!editorEL.hasChildNodes()) {
            commentModifiers[`modifier-${idx}`] = new MyEditor(modContent, editorEL, options)
        }

        if (modifierEL.style.display != "block") {
            commentModifiers[`modifier-${idx}`].setHTML(modContent)
        }

        for (const i in commentModifiers) {
            commentModifiers[i].view.dom.getRootNode().host.style.display = "none"
        }

        modifierEL.style.display = "block"

        const scrollOffsetY = editorEL.getBoundingClientRect().top - document.body.getBoundingClientRect().top
        window.scroll(window.scrollX, scrollOffsetY)
    }

    async function deleteComment(commentIDX) {
        const uri = `/api/board/${boardCode}/${postingIdx}/comment/${commentIDX}`
        const r = await fetch(uri, {
            method: "DELETE"
        })

        if (r.ok) {
            const response = await r.json()

            if (currentCommentPage == totalCommentPage) {
                await getComments(totalCommentPage)
            } else {
                await getComments(currentCommentPage)
            }

            if (currentCommentPage > totalCommentPage) {
                await getComments(totalCommentPage)
            }
        } else {
            alert("Failed to delete")
        }
    }

    async function updateComment(self) {
        const modifierEL = self.getRootNode().host
        const commentIDX = self.getRootNode().host.dataset.idx
        const content = commentModifiers[modifierEL.id].getHTML()

        const data = {
            "content": content,
            "files": fileIndices
        }

        const uri = `/api/board/${boardCode}/${postingIdx}/comment/${commentIDX}`
        const r = await fetch(uri, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })

        if (r.ok) {
            if (currentCommentPage == totalCommentPage) {
                getComments(totalCommentPage)
            } else {
                getComments(currentCommentPage)
            }
        } else {
            alert("Failed to update")
        }

        modifierEL.style.display = "none"
    }

    function cancelEditComment(self) {
        const modifierEL = self.getRootNode().host
        const modifierROOT = modifierEL.shadowRoot
        const editorEL = modifierROOT.querySelector("#modifier")

        modifierEL.style.display = "none"
    }

    function init() {
        showCommentPageJumper()
        getFilesInfo()
    }
    document.addEventListener("DOMContentLoaded", function () { init() })
</script>

{{template "layout_board_footer" .}}
{{template "board/include/header" .}}

<div>
    <!-- <div>
        {{.Posting.Idx.Int64}}
    </div> -->

    <div>
        <span>{{.Posting.Title.String}}</span>
    </div>

    <div>
        <span>{{.Posting.AuthorName.String}}</span> |
        <span>{{.Posting.RegDate.String}}</span> |
        <span>{{.Posting.Views.Int64}}</span>
    </div>

    <div>
        {{unescape .Posting.Content.String}}
    </div>

    <div id="fileslist-container">
        <ul></ul>
    </div>
</div>

<div>
    <button type="button" onclick="backToList()">List</button>
    <button type="button" onclick="moveToEdit()">Edit</button>
    <button type="button" onclick="deletePosting()">Delete</button>
</div>

<script>
    const queries = new URLSearchParams(window.location.search)
    const boardCode = queries.get("board_code")
    const postingIdx = queries.get("idx")
    const fileIndices = "{{.Posting.Files.String}}"

    function backToList() { location.href = `/board/list?board_code=${boardCode}` }
    function moveToEdit() { location.href = `/board/edit?board_code=${boardCode}&idx=${postingIdx}` }
    async function deletePosting() {
        const uri = `/api/board/${boardCode}/posting/${postingIdx}`
        const r = await fetch(uri, {
            method: "DELETE",
        })

        if (r.ok) {
            alert("Deleted")
            backToList()
        }

        return false
    }

    async function getFilesInfo() {
        const indexList = []
        for (const fidx of fileIndices.split("|")) {
            indexList.push({ idx: parseInt(fidx) })
        }

        const uri = "/api/uploader/files-info"

        const r = await fetch(uri, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(indexList)
        })

        if (r.ok) {
            const response = await r.json()

            const fcontainer = document.querySelector("#fileslist-container > ul")
            response.forEach((f) => {
                const li = document.createElement("li")
                li.setAttribute("id", `file-${f.idx}`)
                li.appendChild(document.createTextNode(`${f.filename}`))

                fcontainer.appendChild(li)
            })
        }
    }

    function init() {
        getFilesInfo()
    }

    document.addEventListener("DOMContentLoaded", function () { init() })
</script>

{{template "board/include/footer" .}}
{{template "board/include/header" .}}

<link rel="stylesheet" href="/assets/css/toastui-editor.min.css" />
<script src="/assets/js/toastui-editor-all.min.js"></script>

<div>
    <!-- <div>
        {{.Posting.Idx.Int64}}
    </div> -->

    <div>
        <span>{{.Posting.Title.String}}</span>
    </div>

    <div>
        <span>{{.Posting.AuthorName.String}}</span> |
        <span>{{format_date .Posting.RegDate.String}}</span> |
        <span>{{.Posting.Views.Int64}}</span>
    </div>

    <div>
        {{unescape .Posting.Content.String}}
    </div>

    <div id="fileslist-container">
        <ul></ul>
    </div>
</div>

<div>
    <!-- Todo - change button onclick to a href -->
    <button type="button" onclick="backToList()">List</button>
    <button type="button" onclick="moveToEdit()">Edit</button>
    <button type="button" onclick="deletePosting()">Delete</button>
</div>

<!-- Comment -->
<div>
    <div id="comments">
        {{range .Comments.CommentList}}
        <span>{{.AuthorName.String}}</span>|
        <span>{{format_date .RegDate.String}}</span>|
        <span>{{unescape .Content.String}}</span>
        {{end}}
    </div>
</div>

<div>
    <a onclick="getComments(parseInt('1'))">&laquo;</a>
    <a onclick="getComments(parseInt('{{.Comments.CurrentPage}}')-5)">&lt;</a>

    <span id="comment-pages">
        {{range .Comments.PageList}}
        {{if eq . $.Comments.CurrentPage}}
        <b>{{.}}</b>
        {{else}}
        <a onclick="getComments('{{.}}')">{{.}}</a>
        {{end}}
        {{end}}
    </span>

    <a onclick="getComments(parseInt('{{.Comments.CurrentPage}}')+5)">&gt;</a>
    <a onclick="getComments('{{.Comments.TotalPage}}')">&raquo;</a>
</div>

<div id="editor"></div>
<div>
    <button type="button" onclick="writeComment()">Write</button>
</div>

<script>
    const queries = new URLSearchParams(window.location.search)
    const boardCode = queries.get("board_code")
    const postingIdx = queries.get("idx")
    const fileIndices = "{{.Posting.Files.String}}"

    function backToList() { location.href = `/board/list?board_code=${boardCode}` }
    function moveToEdit() { location.href = `/board/edit?board_code=${boardCode}&idx=${postingIdx}` }
    async function deletePosting() {
        const uri = `/api/board/${boardCode}/posting/${postingIdx}`
        const r = await fetch(uri, {
            method: "DELETE",
        })

        if (r.ok) {
            alert("Deleted")
            backToList()
        }

        return false
    }

    const initialContent = ""
    const filesList = []

    const editor = new toastui.Editor({
        el: document.querySelector("#editor"),
        previewStyle: "tab",
        initialEditType: "wysiwyg",
        hideModeSwitch: true,
        height: "250px",
        hooks: { addImageBlobHook: onUploadImage },
        initialValue: initialContent
    })

    async function onUploadImage(blob, callback) {
        const formData = new FormData()
        formData.append("upload-files", blob)

        const uri = "/api/uploader"
        const r = await fetch(uri, {
            method: "POST",
            body: formData
        })

        if (r.ok) {
            const response = await r.json()

            const fcontainer = document.querySelector("#fileslist-container > ul")
            response.files.forEach((f) => {
                callback(`/upload/${f.storagename}`, f.filename)

                const btn = document.createElement("button")
                btn.setAttribute("onclick", `deleteFile('${f.idx}', '${f.storagename}')`)
                btn.appendChild(document.createTextNode("X"))

                const li = document.createElement("li")
                li.setAttribute("id", `file-${f.idx}`)
                li.appendChild(document.createTextNode(`${f.filename}`))
                li.appendChild(btn)

                fcontainer.appendChild(li)

                filesList.push(f)
            })
        }
    }

    let currentCommentPage = parseInt("{{.Comments.CurrentPage}}")
    let totalCommentPage = parseInt("{{.Comments.TotalPage}}")

    /* 
    getComments(page)
    page: number - If page is 0, last comment page
     */
    async function getComments(page = 1) {
        page = parseInt(page)
        if (page < 0) { page = 0 } // last page
        if (page > totalCommentPage) { page = totalCommentPage }

        const commentsContainer = document.querySelector("#comments")
        const pageContainer = document.querySelector("#comment-pages")
        const uri = `/api/board/${boardCode}/${postingIdx}/comment?page=${page}`

        const r = await fetch(uri)

        let commentsHTML = ""
        if (r.ok) {
            const data = await r.json()

            data["comment-list"].forEach((comment) => {
                commentsHTML += `${comment["author-name"]}|${comment["regdate"]}|${comment["content"]}`
            })
            commentsContainer.innerHTML = commentsHTML

            // paging
            const begin = data["current-page"] - 5 > 0 ? data["current-page"] - 5 : 1
            const fin = data["current-page"] + 5 <= data["total-page"] ? data["current-page"] + 5 : data["total-page"]

            if (page == 0) { page = totalCommentPage }

            let pages = ""
            data["page-list"].forEach((p) => {
                if (p == page) {
                    pages += `<b>${p}</b>`
                } else {
                    pages += `<a onclick="getComments('${p}')">${p}</a>`
                }
                pages += "\n"
            })
            pageContainer.innerHTML = pages

            currentCommentPage = data["current-page"]
            totalCommentPage = data["total-page"]
        }
    }

    async function writeComment() {
        const uri = `/api/board/${boardCode}/${postingIdx}/comment`
        const content = editor.getHTML()

        let fileIndices = ""
        for (const f of filesList) { fileIndices += `${f.idx}|` }
        if (fileIndices.length > 0) { fileIndices = fileIndices.slice(0, -1) }

        const data = {
            "author-idx": 1,
            "author-name": "admin",
            "content": content,
            "files": fileIndices
        }

        const r = await fetch(uri, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })

        if (r.ok) {
            // location.href = `/board/list?board_code=${boardCode}`
            getComments(0)
        } else {
            alert("Write failed")
        }

        return false
    }

    async function getFilesInfo() {
        const indexList = []
        for (const fidx of fileIndices.split("|")) {
            indexList.push({ idx: parseInt(fidx) })
        }

        const uri = "/api/uploader/files-info"

        const r = await fetch(uri, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(indexList)
        })

        if (r.ok) {
            const response = await r.json()

            const fcontainer = document.querySelector("#fileslist-container > ul")
            response.forEach((f) => {
                const li = document.createElement("li")
                li.setAttribute("id", `file-${f.idx}`)
                li.appendChild(document.createTextNode(`${f.filename}`))

                fcontainer.appendChild(li)
            })
        }
    }

    function init() { getFilesInfo() }
    document.addEventListener("DOMContentLoaded", function () { init() })
</script>

{{template "board/include/footer" .}}
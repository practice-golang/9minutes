@INCLUDE@board/include/header.html

<div>
    <label for="image-upload">Image:</label>
    <input type="file" id="image-upload" multiple>
    <button type="button" onclick="insertImage()">Upload</button>

</div>
<div>
    <label for="title-image-upload">Title Image:</label>
    <input type="file" id="title-image-upload">
    <button type="button" onclick="insertTitleImage()">Title image upload</button>
</div>
<div>
    <label for="file-upload">File:</label>
    <input type="file" id="file-upload" multiple>
    <button type="button" onclick="insertFile()">Upload</button>
</div>

<div>
    Title: <input type="text" id="title" value="$TITLE$" placeholder="Title">
    Title image: $TITLE_IMAGE$
</div>
<div id="editor"></div>
<div>
    <button type="button" onclick="moveToList()">Cancel</button>
    <button type="button" onclick="updateContent()">Update</button>
</div>

<div id="filelist-container">
    <ul lr-loop="filelist">
        <li>
            <span lr-if="deletelist[$index] == undefined">
                <a href="{{link}}" target="_blank">{{filename}}</a>
                <button lr-click="setFileToDelete($index)">X</button>
            </span>
            <span lr-if="deletelist[$index] != undefined">
                <s><a href="{{link}}" target="_blank">{{filename}}</a></s>
                <button lr-click="unsetFileFromDelete($index)">Undo</button>
            </span>
        </li>
    </ul>
</div>

<link rel="stylesheet" href="/assets/css/editor.css">
<script>"use strict"</script>
<script src="/assets/js/myeditor.js"></script>

<script>
    let data = `$CONTENT$`;
    const url = new URL(window.location.href)
    const urlParams = url.searchParams

    const accessURI = "/upload"

    let titleImage = "$TITLE_IMAGE$"

    const filelistString = "$FILE_LIST$"
    const filelist = new Array()
    const storelist = new Array()
    const deletelist = {}
    const appendlist = new Array()

    const options = {
        uploadFileActionURI: "/api/uploader/file",
        uploadImageActionURI: "/api/uploader/image",
        uploadAccessURI: "/upload",
    }
    const editorEL = document.querySelector("#editor")
    const editor = new MyEditor(data, editorEL, options)

    async function insertFile() {
        const uploadURI = options.uploadFileActionURI
        const accessURI = options.uploadAccessURI

        const files = document.querySelector("#file-upload").files
        for (const file of files) {
            if (file == undefined) {
                return
            } // Selected nothing

            const formData = new FormData()
            formData.append("file", file)

            const r = await fetch(uploadURI, {
                method: 'POST',
                body: formData
            })
            if (r.ok) {
                const result = await r.json()

                filelist.push({ "filename": result.filename })
                storelist.push({ "filename": result.filename + "/" + result.storename })
                appendlist.push({ "filename": result.filename + "/" + result.storename })

                lrFileList.reload()
            }
        }
    }

    async function insertImage() {
        const uploadURI = options.uploadImageActionURI
        const accessURI = options.uploadAccessURI

        const files = document.querySelector("#image-upload").files
        for (const file of files) {
            if (file == undefined) {
                return
            } // Selected nothing

            const formData = new FormData()
            formData.append("file", file)

            const r = await fetch(uploadURI, {
                method: 'POST',
                body: formData
            })
            if (r.ok) {
                const result = await r.json()

                editor.insertImage(`${accessURI}/${result.storename}`)
                filelist.push({ "filename": result.filename })
                storelist.push({ "filename": result.filename + "/" + result.storename })
                appendlist.push({ "filename": result.filename + "/" + result.storename })

                lrFileList.reload()
            }
        }
    }

    async function insertTitleImage() {
        const uploadURI = options.uploadImageActionURI
        const accessURI = options.uploadAccessURI

        const files = document.querySelector("#title-image-upload").files
        for (const file of files) {
            if (file == undefined) {
                return
            } // Selected nothing

            const formData = new FormData()
            formData.append("file", file)

            const r = await fetch(uploadURI, {
                method: 'POST',
                body: formData
            })
            if (r.ok) {
                const result = await r.json()

                titleImage = `${accessURI}/${result.storename}`

                filelist.push({ "filename": result.filename })
                storelist.push({ "filename": result.filename + "/" + result.storename })
                appendlist.push({ "filename": result.filename + "/" + result.storename })

                lrFileList.reload()
            }
        }
    }

    function setFileToDelete(idx) {
        const names = storelist[idx].filename.split("/")
        deletelist[idx] = { "filename": names[0], "storename": names[1] }

        lrFileList.reload()
    }

    function unsetFileFromDelete(idx) {
        delete deletelist[idx]

        lrFileList.reload()
    }

    async function updateContent() {
        for (const idx in storelist) {
            for (const j in deletelist) {
                if (deletelist[j].filename + "/" + deletelist[j].storename == storelist[idx].filename) {
                    storelist.splice(idx, 1)
                }
            }
        }
        const storeListArray = storelist.map(file => { return file.filename })
        const storeListString = storeListArray.join("?")
        const deleteFiles = Object.values(deletelist)

        const data = {
            "idx": urlParams.get("idx"),
            "title": document.querySelector("#title").value,
            "title-image": titleImage,
            "content": editor.getHTML(),
            "files": storeListString,
            "delete-files": deleteFiles
        }

        const r = await fetch("/api/board/content/$CODE$/$IDX$", {
            method: 'PUT',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })

        if (r.ok) {
            location.href = "/board/read.html?code=$CODE$&idx=$IDX$"
        } else {
            alert("Server error")
        }

        return false
    }

    function moveToList() {
        location.href = "/board?code=" + urlParams.get("code")
        // history.back()
    }

    for (const f of filelistString.split("?")) {
        if (f == "") { continue }

        storelist.push({ "filename": f })

        const files = f.split("/")
        filelist.push({
            "storename": files[1],
            "filename": files[0],
            "link": accessURI + "/" + files[1]
        })
    }

    const lrFileList = new ListRenderer(document.getElementById("filelist-container"))
    lrFileList.render()

    async function cancelprocess() {
        const data = { "idx": urlParams.get("idx"), "delete-files": appendlist }

        const r = await fetch("/api/uploader/file", {
            method: 'DELETE',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
    }

    window.onbeforeunload = function () { cancelprocess() }
</script>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    /*
     Need js for custom resize handle??? :
     https://spin.atomicobject.com/2019/11/21/creating-a-resizable-html-element
     */
    #editor {
        resize: vertical;
        overflow: auto;

        border: 1px solid silver;
    }

    #editor img {
        max-width: 70vw;
        overflow: auto;
    }
</style>

@INCLUDE@board/include/footer.html